user  root;
worker_processes  auto;

daemon on;
#pid logs/nginx.pid;

#error_log  logs/error.log  info;
error_log  logs/error.log info;
#error_log  /dev/stdout info;

events {
    worker_connections  1024;
}

stream {
    lua_package_path '{path}/pgsql_proxy/lualib/?.lua;{path}/pgsql_proxy/nginx/mylua/?.lua;{path}/pgsql_proxy/lualib/?.ljbc;{path}/pgsql_proxy/lualib/?/init.ljbc;{path}/pgsql_proxy/lualib/?/init.lua;;';
    lua_package_cpath "{path}/pgsql_proxy/lualib/?.so;;";
    
    lua_shared_dict pgsql_audit_log 20m;
    lua_shared_dict locks 10m;
    lua_shared_dict current_db_connect_number 10m;

    lua_shared_dict pgsql_db_address_info 10m;
    lua_shared_dict pgsql_proxy_app_logs 100m;

    #lua_code_cache off;

    bwda_proxy_switch off;
    bwda_proxy_sm4_switch off;

    lua_socket_buffer_size 16k;

    init_by_lua_block {
        local cfgreader = require "init"
        local cfg_file = "{path}/pgsql_proxy/conf/globalConfig.json"
        cfgreader.get_global_cfg(cfg_file)

        -- ngx.log(ngx.INFO, "lua package.path: ", package.path)
        -- ngx.log(ngx.INFO, "lua package.cpath: ", package.cpath)
    }
    
    init_worker_by_lua_block {
        local initer = require("init_worker")
        initer.init_worker()
    }
    
    server {
        listen 9200-9202;
        proxy_timeout 1h;
        content_by_lua_block {
            local pg_proxy = require "pgsql_proxy_app"
            pg_proxy.run()
        }
    }

    server {
        listen 2345;
        content_by_lua_block {
            local sock = ngx.req.socket(true)
            local clientdata, err = sock:receiveany(81920)  -- 非阻塞读取
            if clientdata then
                local parser = require "parse_opcode_msg"
                parser.parse_opcode_msg(sock, clientdata)
            end
        }
    }
}

http {
    lua_package_path '{path}/pgsql_proxy/lualib/?.lua;{path}/pgsql_proxy/nginx/mylua/?.lua;{path}/pgsql_proxy/lualib/?.ljbc;{path}/pgsql_proxy/lualib/?/init.ljbc;{path}/pgsql_proxy/lualib/?/init.lua;;';
    lua_package_cpath "{path}/pgsql_proxy/lualib/?.so;;";

    include       mime.types;
    default_type  application/octet-stream;
	
	server {
        listen 3900;
        server_name localhost;

        location /message/api/getSipTunnel {
            content_by_lua_block {
                ngx.req.read_body()
                local body = ngx.req.get_body_data()
                local cjson = require "cjson.safe"
                local data = cjson.decode(body)
                local jsonarr = {}
                table.insert(jsonarr, {vpPort="9200",targetIp="192.168.104.100",targetPort="5432",targetType="13"})
                table.insert(jsonarr, {vpPort="9201",targetIp="192.168.100.20",targetPort="5432",targetType="13"})
                table.insert(jsonarr, {vpPort="9202",targetIp="192.168.100.21",targetPort="5432",targetType="13"})
                local json_str = cjson.encode(jsonarr)
                ngx.print(json_str)
            }
        } 
    }
    
    server {
        listen       1201;
        server_name  localhost;

        location /unlock_account {
            content_by_lua_block {
                local reader = require "deal_http_msg"
                reader.forward_http_msg("unlock_account", true)
            }
        }
        
        location /lock_account {
            content_by_lua_block {
                local reader = require "deal_http_msg"
                reader.forward_http_msg("lock_account", true)
            }
        }

        location /add_db_control_policy {
            content_by_lua_block {
                local reader = require "deal_http_msg"
                reader.forward_http_msg("add_db_control_policy", true)
            }
        }

        location /delete_db_control_policy {
            content_by_lua_block {
                local reader = require "deal_http_msg"
                reader.forward_http_msg("delete_db_control_policy", true)
            }
        }

        location /update_db_control_policy {
            content_by_lua_block {
                local reader = require "deal_http_msg"
                reader.forward_http_msg("update_db_control_policy", true)
            }
        }

        location /get_db_current_config_info {
            content_by_lua_block {
                local reader = require "deal_http_msg"
                reader.send_and_recv_msg("get_db_current_config_info")
            }
        }
    }
}
